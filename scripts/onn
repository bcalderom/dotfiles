#!/usr/bin/env bash
set -euo pipefail

MODE="note"
OVERRIDE_DIR=""
OVERRIDE_TEMPLATE_SPEC=""

usage() {
  cat <<EOF
Usage: $(basename "$0") [options] [title]

Options:
  -n, --note            Create a note (default)
  -d, --daily           Create/open a daily note (YYYY-MM-DD; defaults to today)
      --meeting         Create a note using meeting.md
      --person          Create a note using person.md
      --project         Create a note using _Project.md
      --incident        Create a note using incident.md
      --improvement     Create a note using improvement.md
      --decision        Create a note using decision.md
      --enablement      Create a note using enablement.md
      --operational     Create a note using operational.md
      --commitment      Create a note using commitment.md
      --dir PATH        Override target directory
      --template PATH   Override template file path
  -h, --help            Show this help

Environment overrides:
  ONN_VAULT, ONN_NOTE_DIR, ONN_DAILY_DIR, ONN_TEMPLATE_DIR,
  ONN_NOTE_TEMPLATE, ONN_DAILY_TEMPLATE
EOF
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    -n|--note)
      MODE="note"
      shift
      ;;
    -d|--daily)
      MODE="daily"
      shift
      ;;
    --meeting)
      MODE="note"
      OVERRIDE_TEMPLATE_SPEC="preset:meeting.md"
      shift
      ;;
    --person)
      MODE="note"
      OVERRIDE_TEMPLATE_SPEC="preset:person.md"
      shift
      ;;
    --project)
      MODE="note"
      OVERRIDE_TEMPLATE_SPEC="preset:_Project.md"
      shift
      ;;
    --incident)
      MODE="note"
      OVERRIDE_TEMPLATE_SPEC="preset:incident.md"
      shift
      ;;
    --improvement)
      MODE="note"
      OVERRIDE_TEMPLATE_SPEC="preset:improvement.md"
      shift
      ;;
    --decision)
      MODE="note"
      OVERRIDE_TEMPLATE_SPEC="preset:decision.md"
      shift
      ;;
    --enablement)
      MODE="note"
      OVERRIDE_TEMPLATE_SPEC="preset:enablement.md"
      shift
      ;;
    --operational)
      MODE="note"
      OVERRIDE_TEMPLATE_SPEC="preset:operational.md"
      shift
      ;;
    --commitment)
      MODE="note"
      OVERRIDE_TEMPLATE_SPEC="preset:commitment.md"
      shift
      ;;
    --dir)
      OVERRIDE_DIR="${2:-}"
      if [[ -z "${OVERRIDE_DIR}" ]]; then
        echo "Missing value for --dir" >&2
        exit 2
      fi
      shift 2
      ;;
    --template)
      OVERRIDE_TEMPLATE_SPEC="path:${2:-}"
      if [[ -z "${OVERRIDE_TEMPLATE_SPEC#path:}" ]]; then
        echo "Missing value for --template" >&2
        exit 2
      fi
      shift 2
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    --)
      shift
      break
      ;;
    -*)
      echo "Unknown argument: $1" >&2
      exit 2
      ;;
    *)
      break
      ;;
  esac
done

VAULT="${ONN_VAULT:-$HOME/Obsidian/engineer}"
NOTE_DIR="${ONN_NOTE_DIR:-$VAULT/0 Inbox}"
DAILY_DIR="${ONN_DAILY_DIR:-$VAULT/Daily}"

TEMPLATE_DIR="${ONN_TEMPLATE_DIR:-$VAULT/3 Resources/templates/}"
NOTE_TEMPLATE="${ONN_NOTE_TEMPLATE:-$TEMPLATE_DIR/new-nvim-note.md}"
DAILY_TEMPLATE="${ONN_DAILY_TEMPLATE:-$TEMPLATE_DIR/daily.md}"

resolve_template_path() {
  local default_path="$1"
  if [[ -z "${OVERRIDE_TEMPLATE_SPEC}" ]]; then
    printf "%s" "${default_path}"
    return 0
  fi

  case "${OVERRIDE_TEMPLATE_SPEC}" in
    preset:*)
      printf "%s/%s" "${TEMPLATE_DIR%/}" "${OVERRIDE_TEMPLATE_SPEC#preset:}"
      ;;
    path:*)
      printf "%s" "${OVERRIDE_TEMPLATE_SPEC#path:}"
      ;;
    *)
      printf "%s" "${default_path}"
      ;;
  esac
}

slugify() {
  local s="$1"
  s="$(printf "%s" "$s" | tr '[:upper:]' '[:lower:]')"
  s="$(printf "%s" "$s" | sed -E 's/[[:space:]]+/-/g')"
  s="$(printf "%s" "$s" | sed -E 's/[^a-z0-9-]//g')"
  s="$(printf "%s" "$s" | sed -E 's/-+/-/g; s/^-+//; s/-+$//')"
  printf "%s" "$s"
}

escape_sed_replacement() {
  printf '%s' "$1" | sed -e 's/[\\&@]/\\\\&/g'
}

render_template_inplace() {
  local file="$1"
  local date_value="$2"
  local created_iso="$3"
  local title_value="$4"
  local daily_nav_value="${5:-}"

  local date_esc created_esc title_esc slug_esc
  date_esc="$(escape_sed_replacement "$date_value")"
  created_esc="$(escape_sed_replacement "$created_iso")"
  title_esc="$(escape_sed_replacement "$title_value")"
  slug_esc="$(escape_sed_replacement "$(slugify "$title_value")")"
  local daily_nav_esc
  daily_nav_esc="$(escape_sed_replacement "$daily_nav_value")"

  sed -i \
    -e "s@{{date}}@${date_esc}@g" \
    -e "s@{{daily_date}}@${date_esc}@g" \
    -e "s@{{created_iso}}@${created_esc}@g" \
    -e "s@{{created}}@${created_esc}@g" \
    -e "s@{{title}}@${title_esc}@g" \
    -e "s@{{slug}}@${slug_esc}@g" \
    -e "s@{{daily_nav}}@${daily_nav_esc}@g" \
    "$file"
}

prompt_title() {
  local prompt="${1:-Note title:}"
  local title=""
  read -r -p "${prompt} " title || true
  printf "%s" "$title"
}

# Returns "FINAL_TITLE|TARGET_PATH"
ensure_unique_target() {
  local title="$1"
  local target_dir="$2"

  while true; do
    if [[ -z "${title// /}" ]]; then
      title="$(prompt_title "Note title:")"
      continue
    fi

    local slug
    slug="$(slugify "$title")"
    if [[ -z "$slug" ]]; then
      echo "The title does not produce a valid filename." >&2
      title="$(prompt_title "New title:")"
      continue
    fi

    local target="$target_dir/$slug.md"
    if [[ -e "$target" ]]; then
      # Mostrar ruta con espacios escapados (\ )
      escaped_target="${target// /\\ }"
      echo "Already exists: $escaped_target" >&2
      title="$(prompt_title "New title:")"
      continue
    fi

    printf "%s|%s\n" "$title" "$target"
    return 0
  done
}

EDITOR_CMD="${EDITOR:-nvim}"
CREATED="$(date +'%Y-%m-%dT%H:%M')"

if [[ "${MODE}" == "daily" ]]; then
  if [[ $# -gt 1 ]]; then
    echo "Too many arguments for --daily" >&2
    exit 2
  fi

  DAILY_DATE="${1:-$(date +%F)}"
  if [[ ! "${DAILY_DATE}" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
    echo "Invalid date for daily note (expected YYYY-MM-DD): ${DAILY_DATE}" >&2
    exit 2
  fi

  TARGET_DIR="${OVERRIDE_DIR:-$DAILY_DIR}"
  TEMPLATE_PATH="$(resolve_template_path "$DAILY_TEMPLATE")"
  mkdir -p "$TARGET_DIR"

  TARGET="$TARGET_DIR/$DAILY_DATE.md"
  if [[ -e "$TARGET" ]]; then
    "$EDITOR_CMD" "$TARGET"
    escaped_final="${TARGET// /\\ }"
    echo "Opened: $escaped_final"
    exit 0
  fi
else
  TARGET_DIR="${OVERRIDE_DIR:-$NOTE_DIR}"
  TEMPLATE_PATH="$(resolve_template_path "$NOTE_TEMPLATE")"
  mkdir -p "$TARGET_DIR"

  TITLE="${*:-}"
  if [[ -z "${TITLE// /}" ]]; then
    TITLE="$(prompt_title "Note title:")"
  fi

  PAIR="$(ensure_unique_target "$TITLE" "$TARGET_DIR")"
  TARGET="${PAIR#*|}"
fi

CLEANUP_TARGET=1
trap 'if [[ "${CLEANUP_TARGET}" -eq 1 ]]; then rm -f -- "${TARGET}"; fi' EXIT

USED_TEMPLATE_FILE=0
if [[ -f "${TEMPLATE_PATH}" ]]; then
  cp "${TEMPLATE_PATH}" "${TARGET}"
  USED_TEMPLATE_FILE=1
else
  cat >"${TARGET}" <<EOF
---
Created: $CREATED
tags: []
---


EOF
fi

if [[ "${MODE}" == "daily" ]]; then
  YESTERDAY_DATE="$(date -d "${DAILY_DATE} -1 day" +%F)"
  TOMORROW_DATE="$(date -d "${DAILY_DATE} +1 day" +%F)"
  DAILY_NAV="<< [[${YESTERDAY_DATE}|Yesterday]] | [[${TOMORROW_DATE}|Tomorrow]] >>"
  render_template_inplace "${TARGET}" "${DAILY_DATE}" "${CREATED}" "${DAILY_DATE}" "${DAILY_NAV}"
else
  render_template_inplace "${TARGET}" "$(date +%F)" "${CREATED}" "${TITLE}" ""
fi

BASE_HASH="$(sha256sum "${TARGET}" | awk '{print $1}')"

if [[ "${MODE}" == "note" ]] && [[ "$(basename -- "${EDITOR_CMD}")" =~ ^(nvim|vim)$ ]]; then
  "$EDITOR_CMD" +"call cursor(6,1)" +startinsert "${TARGET}"
else
  "$EDITOR_CMD" "${TARGET}"
fi

NEW_HASH="$(sha256sum "${TARGET}" | awk '{print $1}')"
if [[ "$NEW_HASH" == "$BASE_HASH" ]]; then
  echo "Discarded (no changes)."
  exit 0
fi

if [[ "$USED_TEMPLATE_FILE" -eq 0 ]] && ! awk '
  BEGIN{in_yaml=0; saw_end=0; content=0}
  NR==1 && $0 ~ /^---[[:space:]]*$/ {in_yaml=1; next}
  in_yaml && $0 ~ /^---[[:space:]]*$/ {saw_end=1; in_yaml=0; next}
  saw_end {
    if ($0 !~ /^[[:space:]]*$/) {content=1}
  }
  END{exit content?0:1}
' "${TARGET}"; then
  echo "Discarded (template only)."
  exit 0
fi

CLEANUP_TARGET=0
trap - EXIT

escaped_final="${TARGET// /\\ }"
echo "Saved: $escaped_final"

