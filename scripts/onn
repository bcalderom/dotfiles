#!/usr/bin/env bash
set -euo pipefail

VAULT="$HOME/Obsidian/engineer"
INBOX="$VAULT/0 Inbox"

slugify() {
  local s="$1"
  s="$(printf "%s" "$s" | tr '[:upper:]' '[:lower:]')"
  s="$(printf "%s" "$s" | sed -E 's/[[:space:]]+/-/g')"
  s="$(printf "%s" "$s" | sed -E 's/[^a-z0-9-]//g')"
  s="$(printf "%s" "$s" | sed -E 's/-+/-/g; s/^-+//; s/-+$//')"
  printf "%s" "$s"
}

prompt_title() {
  local prompt="${1:-Note title:}"
  local title=""
  read -r -p "${prompt} " title || true
  printf "%s" "$title"
}

# Returns "FINAL_TITLE|TARGET_PATH"
ensure_unique_target() {
  local title="$1"

  while true; do
    if [[ -z "${title// /}" ]]; then
      title="$(prompt_title "Note title:")"
      continue
    fi

    local slug
    slug="$(slugify "$title")"
    if [[ -z "$slug" ]]; then
      echo "El título no produce un nombre de archivo válido."
      title="$(prompt_title "Nuevo título:")"
      continue
    fi

    local target="$INBOX/$slug.md"
    if [[ -e "$target" ]]; then
      # Mostrar ruta con espacios escapados (\ )
      escaped_target="${target// /\\ }"
      echo "Ya existe: $escaped_target" >&2
      title="$(prompt_title "Nuevo título:")"
      continue
    fi

    printf "%s|%s\n" "$title" "$target"
    return 0
  done
}

mkdir -p "$INBOX"

TITLE="${*:-}"
if [[ -z "${TITLE// /}" ]]; then
  TITLE="$(prompt_title "Note title:")"
fi

PAIR="$(ensure_unique_target "$TITLE")"
TARGET="${PAIR#*|}"

CREATED="$(date +'%Y-%m-%dT%H:%M')"
TMP="$(mktemp --suffix=.md)"
trap 'rm -f "$TMP"' EXIT

cat >"$TMP" <<EOF
---
Created: $CREATED
tags: []
---


EOF

BASE_HASH="$(sha256sum "$TMP" | awk '{print $1}')"

nvim +"call cursor(6,1)" +startinsert "$TMP"

NEW_HASH="$(sha256sum "$TMP" | awk '{print $1}')"
if [[ "$NEW_HASH" == "$BASE_HASH" ]]; then
  echo "Descartado (sin cambios)."
  exit 0
fi

if ! awk '
  BEGIN{in_yaml=0; saw_end=0; content=0}
  NR==1 && $0 ~ /^---[[:space:]]*$/ {in_yaml=1; next}
  in_yaml && $0 ~ /^---[[:space:]]*$/ {saw_end=1; in_yaml=0; next}
  saw_end {
    if ($0 !~ /^[[:space:]]*$/) {content=1}
  }
  END{exit content?0:1}
' "$TMP"; then
  echo "Descartado (solo template)."
  exit 0
fi

mv "$TMP" "$TARGET"
trap - EXIT

# Mostrar ruta con espacios escapados (\ )
escaped_final="${TARGET// /\\ }"
echo "Guardado: $escaped_final"
