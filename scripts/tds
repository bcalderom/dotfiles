#!/usr/bin/env bash
# tds (Tmux Developer Session)
# Usage: tds [--root PATH] [--depth N]
# - --root PATH   Search root directory (default: current directory)
# - --depth N     Search depth for subdirectories (default: 1)
# - -h, --help    Show usage

set -euo pipefail

ROOT="${PWD}"
DEPTH="1"
LEFT_PERCENT="35"
RIGHT_PERCENT="65"
RIGHT_TOP_PERCENT="80"
RIGHT_BOTTOM_PERCENT="20"
DEBUG="false"

usage() {
  cat <<EOF
Usage: tds [--root PATH] [--depth N]

Options:
  --root PATH   Search root directory (default: current directory)
  --depth N     Search depth for subdirectories (default: 1)
  --debug       Print tmux layout debug info
  -h, --help    Show this help
EOF
}

die() {
  echo "Error: $*" >&2
  exit 1
}

have() {
  command -v "$1" >/dev/null 2>&1
}

require_apps() {
  local missing=()
  local app

  for app in "$@"; do
    if ! have "${app}"; then
      missing+=("${app}")
    fi
  done

  if (( ${#missing[@]} > 0 )); then
    local label="tools"
    if (( ${#missing[@]} == 1 )); then
      label="tool"
    fi
    die "Missing required ${label}: ${missing[*]}"
  fi
}

validate_percent() {
  local value="$1"
  local name="$2"

  if [[ ! "${value}" =~ ^[0-9]+$ ]]; then
    die "${name} must be an integer percentage."
  fi

  if (( value < 1 || value > 99 )); then
    die "${name} must be between 1 and 99."
  fi
}

debug_log() {
  if [[ "${DEBUG}" == "true" ]]; then
    echo "DEBUG: $*" >&2
  fi
}

pane_size() {
  tmux display-message -p -t "$1" '#{pane_width}x#{pane_height}' 2>/dev/null
}

window_size() {
  tmux display-message -p -t "$1" '#{window_width}x#{window_height}' 2>/dev/null
}

escape_shell() {
  printf '%q' "$1"
}

split_pane() {
  local target="$1"
  local orientation="$2"
  local percent="$3"
  local pane
  local pane_dims
  local window_dims

  pane_dims="$(pane_size "${target}")"
  window_dims="$(window_size "${target}")"
  debug_log "Splitting ${target} ${orientation} ${percent}% (pane ${pane_dims}, window ${window_dims})"

  if ! pane="$(tmux split-window -t "${target}" "${orientation}" -p "${percent}" -P -F '#{pane_id}' -c "${DIR}")"; then
    window_dims="$(window_size "${target}")"
    pane_dims="$(pane_size "${target}")"
    debug_log "Split failed for ${target} (pane ${pane_dims}, window ${window_dims})"
    echo "Window too small for requested layout. Resize and retry." >&2
    exit 1
  fi

  printf '%s' "${pane}"
}

require_apps tmux fzf nvim opencode

if [[ -z "${TMUX:-}" ]]; then
  echo "tmux is not running. Launching tmux..." >&2
  script_path="$(command -v tds 2>/dev/null || printf '%s' "$0")"
  script_path_escaped="$(escape_shell "${script_path}")"
  script_cmd="${script_path_escaped}"

  for arg in "$@"; do
    script_cmd+=" $(escape_shell "${arg}")"
  done

  if tmux has-session -t tds 2>/dev/null; then
    exec tmux attach -t tds
  fi

  tmux new-session -d -s tds -n tds
  tmux send-keys -t "tds:tds" "${script_cmd}" C-m
  exec tmux attach -t tds
fi

while [[ $# -gt 0 ]]; do
  case "$1" in
    --root)
      ROOT="${2:-}"
      shift 2
      ;;
    --depth)
      DEPTH="${2:-}"
      shift 2
      ;;
    --debug)
      DEBUG="true"
      shift 1
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      die "Unknown argument: $1"
      ;;
  esac
done


if [[ -z "${ROOT}" ]]; then
  die "--root cannot be empty."
fi

if [[ ! -d "${ROOT}" ]]; then
  die "Root directory not found: ${ROOT}"
fi

if [[ ! "${DEPTH}" =~ ^[0-9]+$ ]]; then
  die "--depth must be a non-negative integer."
fi

validate_percent "${LEFT_PERCENT}" "LEFT_PERCENT"
validate_percent "${RIGHT_PERCENT}" "RIGHT_PERCENT"
validate_percent "${RIGHT_TOP_PERCENT}" "RIGHT_TOP_PERCENT"
validate_percent "${RIGHT_BOTTOM_PERCENT}" "RIGHT_BOTTOM_PERCENT"

if (( LEFT_PERCENT + RIGHT_PERCENT != 100 )); then
  die "LEFT_PERCENT and RIGHT_PERCENT must sum to 100."
fi

if (( RIGHT_TOP_PERCENT + RIGHT_BOTTOM_PERCENT != 100 )); then
  die "RIGHT_TOP_PERCENT and RIGHT_BOTTOM_PERCENT must sum to 100."
fi

list_dirs() {
  printf '%s\n' "${ROOT}"
  find "${ROOT}" -maxdepth "${DEPTH}" -mindepth 1 \
    \( -name .git -o -name node_modules -o -name .venv -o -name venv -o -name dist -o -name build -o -name .cache \) -prune -o \
    -type d -print
}

DIR="$(list_dirs | fzf --prompt="Select directory: " || true)"
if [[ -z "${DIR}" ]]; then
  exit 0
fi

SESSION_NAME="$(tmux display-message -p '#{session_name}')"
WINDOW_ID="$(tmux display-message -p '#{window_id}')"
CURRENT_PANE_ID="$(tmux display-message -p '#{pane_id}')"
WINDOW_PANES="$(tmux display-message -p '#{window_panes}')"

if [[ "${DEBUG}" == "true" ]]; then
  debug_log "Session ${SESSION_NAME}, window ${WINDOW_ID}, panes ${WINDOW_PANES}"
  debug_log "Window size $(window_size "${CURRENT_PANE_ID}")"
  debug_log "Current pane size $(pane_size "${CURRENT_PANE_ID}")"
fi

target_window="${SESSION_NAME}:${WINDOW_ID}"
left_pane="${CURRENT_PANE_ID}"

if [[ "${WINDOW_PANES}" -gt 1 ]]; then
  tmux kill-pane -a -t "${left_pane}"
fi

right_pane="$(split_pane "${left_pane}" -h "${RIGHT_PERCENT}")"
bottom_right_pane="$(split_pane "${right_pane}" -v "${RIGHT_BOTTOM_PERCENT}")"
top_right_pane="${right_pane}"

dir_escaped="$(escape_shell "${DIR}")"

tmux send-keys -t "${left_pane}" "cd -- ${dir_escaped}" C-m
tmux send-keys -t "${left_pane}" "nvim ." C-m

tmux send-keys -t "${top_right_pane}" "cd -- ${dir_escaped}" C-m

tmux send-keys -t "${bottom_right_pane}" "cd -- ${dir_escaped}" C-m

tmux select-pane -t "${left_pane}"
