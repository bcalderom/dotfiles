#!/usr/bin/env zsh

topdisk() {
  # Interactive disk usage explorer with empty-dir detection.
  #
  # Usage:
  #   topdisk [path] [depth]
  #
  # Dependencies: fzf, du, sort, ls, clear, cat

  # ---- Declare full binary paths ----
  local CD_BIN="/usr/bin/cd"
  local DU_BIN="/usr/bin/du"
  local SORT_BIN="/usr/bin/sort"
  local LS_BIN="/usr/bin/ls"
  local FZF_BIN="/usr/bin/fzf"
  local CLEAR_BIN="/usr/bin/clear"
  local FIND_BIN="/usr/bin/find"

  # ---- Function parameters ----
  local start_path="${1:-$PWD}"
  local depth="${2:-1}"

  local explore_dir="$start_path"

  while true; do
    # Resolve symlinks
    if [[ -L "$explore_dir" ]]; then
      explore_dir=$(readlink -f "$explore_dir")
    fi

    $CLEAR_BIN
    echo "ğŸ“Š Scanning: $explore_dir (depth: $depth)"
    echo "-----------------------------------------------------------"
    echo "â³ Generating scan..."

    # ---- Run disk usage scan ----
    local du_output
    local du_errors
    du_errors=$(mktemp)
    du_output=$($DU_BIN -ah -x --max-depth="$depth" "$explore_dir" 2>"$du_errors" | $SORT_BIN -rh)
    
    # Check for permission errors
    if grep -q "Permission denied" "$du_errors" 2>/dev/null; then
      echo "âš ï¸  You don't have permission to read this directory."
      rm -f "$du_errors"
      echo
      read "?Press Enter to return..."
      break
    fi
    rm -f "$du_errors"

    # ---- Handle empty directory case ----
    if [[ -z "$du_output" ]]; then
      echo "ğŸ“ Directory is empty."
      echo
      read "?Press Enter to return to the previous directory or exit..."
      break
    fi

    echo
    echo "Use â†‘â†“ to navigate, Enter to open directory, ESC to quit."
    echo

    # ---- fzf interactive navigation ----
    local selection
    selection=$(echo "$du_output" | $FZF_BIN \
      --prompt="Select file or directory > " \
      --height=90% --reverse \
      --preview="p={}; p=\$(printf '%s\n' \"\$p\" | cut -f2-); if [[ -d \"\$p\" ]]; then $LS_BIN -lhtr --color=always \"\$p\"; else $LS_BIN -lh --color=always \"\$p\"; fi" \
      --preview-window=right:60%)

    [[ -z "$selection" ]] && echo "ğŸ‘‹ Exiting." && break

    local selected_path="$(printf '%s\n' "$selection" | cut -f2-)"

    $CLEAR_BIN
    echo "ğŸ“‚ Selected: $selected_path"
    echo "-----------------------------------------------------------"

    # ---- Action based on selection ----
    if [[ -d "$selected_path" ]]; then
      # Check if directory is empty before entering
      if [[ -z $($FIND_BIN "$selected_path" -mindepth 1 -print -quit 2>/dev/null) ]]; then
        echo "ğŸ“ Directory is empty."
        echo
        read "?Press Enter to return..."
      else
        explore_dir="$selected_path"
      fi
    else
      $LS_BIN -lh "$selected_path"
      echo
      read "?Press Enter to return..."
    fi
  done
}

topdisk "$@"
